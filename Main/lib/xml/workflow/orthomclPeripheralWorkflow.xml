<workflowGraph name="">
  <param name="parentDataDir"/>
  <param name="residualGroupIdPrefix"/>
  <param name="residualGroupIdStart"/>
  <param name="oldReleasesGroupFilesDir"/>
  <param name="relativeDownloadSiteDir"/>
  <param name="projectVersionForWebsiteFiles"/>
  <param name="coreProteome"/>
  <param name="coreResultsDir"/>

  <constant name="projectName">OrthoMCL</constant>
  <constant name="getPeripheralProteinsDir">$$parentDataDir$$/getPeripheralProteins</constant>
  <constant name="residualFastaFilesDir">$$getPeripheralProteinsDir$$/residualFastaFiles</constant>
  <constant name="makeResidualGroupsDir">$$parentDataDir$$/makeResidualGroups</constant>
  <constant name="residualGroupsDir">$$parentDataDir$$/residualGroups</constant>
  <constant name="peripheralDir">$$parentDataDir$$/peripheral</constant>

  <subgraph name="getPeripheralProteomes" xmlFile="generated/OrthoMCL/orthomclGetPeripheralProteins.xml">
    <paramValue name="parentDataDir">$$parentDataDir$$</paramValue>
    <paramValue name="getPeripheralProteinsDir">$$getPeripheralProteinsDir$$</paramValue>
    <paramValue name="residualFastaFilesDir">$$residualFastaFilesDir$$</paramValue>
    <paramValue name="oldReleasesGroupFilesDir">$$oldReleasesGroupFilesDir$$</paramValue>
  </subgraph>

  <step name="makePeripheralDir" stepClass="ReFlow::StepClasses::MakeDataDir">
      <paramValue name="dataDir">$$peripheralDir$$</paramValue>
      <depends name="getPeripheralProteomes"/>
  </step>

  <step name="makePeripheralResultsDir" stepClass="ReFlow::StepClasses::MakeDataDir">
    <paramValue name="dataDir">$$peripheralDir$$/master/</paramValue>
    <depends name="makePeripheralDir"/>
   </step>

  <step name="CopyAndUncompressPeripheralCacheDir" stepClass="OrthoMCLWorkflow::Main::WorkflowSteps::CopyAndUncompressPeripheralCacheDir">
    <paramValue name="outputDir">$$peripheralDir$$</paramValue>
    <depends name="makePeripheralResultsDir"/>
  </step>

  <step name="makeOrthoFinderPeripheralNextflowConfig" stepClass="OrthoMCLWorkflow::Main::WorkflowSteps::MakeOrthoFinderPeripheralNextflowConfig">
    <paramValue name="clusterResultDir">$$peripheralDir$$/master/mainresult/</paramValue>
    <paramValue name="configFileName">nextflow.config</paramValue>
    <paramValue name="analysisDir">$$peripheralDir$$</paramValue>
    <paramValue name="peripheralProteomes">$$getPeripheralProteinsDir$$/fastas.tar.gz</paramValue>
    <paramValue name="coreProteome">$$coreProteome$$</paramValue>
    <paramValue name="coreBestReps">$$coreResultsDir$$/bestReps.fasta</paramValue>
    <paramValue name="coreGroupsFile">$$coreResultsDir$$/reformattedGroups.txt</paramValue>
    <paramValue name="coreSimilarityToBestReps">$$coreResultsDir$$/coreSimilarityToBestReps</paramValue>
    <paramValue name="coreBestRepsSelfBlast">$$coreResultsDir$$/core_best_reps_self_blast.txt</paramValue>
    <paramValue name="peripheralCacheDir">$$peripheralDir$$/peripheralCacheDir</paramValue>
    <paramValue name="outdated">$$coreResultsDir$$/../../outdated.txt</paramValue>
    <depends name="CopyAndUncompressPeripheralCacheDir"/>
  </step>

  <step name="mirrorToCluster" stepClass="ReFlow::StepClasses::MirrorToComputeCluster" stepLoadTypes="toCluster">
    <paramValue name="fileOrDirToMirror">$$peripheralDir$$</paramValue>
    <depends name="makeOrthoFinderPeripheralNextflowConfig"/>
  </step>

  <step name="runOrthoFinderPeripheralClusterTask" stepClass="ReFlow::StepClasses::RunAndMonitorNextflowWithEntry">
    <paramValue name="workingDir">$$peripheralDir$$</paramValue>
    <paramValue name="resultsDir">$$peripheralDir$$/master/mainresult</paramValue>
    <paramValue name="nextflowConfigFile">$$peripheralDir$$/nextflow.config</paramValue>
    <paramValue name="nextflowWorkflow">VEuPathDB/orthofinder-nextflow</paramValue>
    <paramValue name="isGitRepo">true</paramValue>
    <paramValue name="entry">peripheralEntry</paramValue>
    <depends name="mirrorToCluster"/>
  </step>

  <step name="mirrorFromCluster" stepClass="ReFlow::StepClasses::MirrorFromComputeCluster">
    <paramValue name="fileOrDirToMirror">$$peripheralDir$$/master/mainresult</paramValue>
    <paramValue name="outputDir">$$peripheralDir$$/master/mainresult</paramValue>
    <paramValue name="outputFiles"></paramValue>
    <paramValue name="deleteAfterCopy">false</paramValue>
    <depends name="runOrthoFinderPeripheralClusterTask"/>
  </step>     

  <step name="loadCoreGroups" stepClass="OrthoMCLWorkflow::Main::WorkflowSteps::InsertOrthoGroups">
      <paramValue name="groupsFile">$$peripheralDir$$/master/mainresult/GroupsFile.txt</paramValue>
      <paramValue name="isResidual">0</paramValue>
      <depends name="mirrorFromCluster"/>
  </step>

<!-- N0.tsv file? -->
  <step name="loadResidualGroups" stepClass="OrthoMCLWorkflow::Main::WorkflowSteps::InsertOrthoGroups">
    <paramValue name="groupsFile">$$peripheralDir$$/master/mainresult/Results/Orthogroups/Orthogroups.txt</paramValue>
    <paramValue name="isResidual">1</paramValue>
    <depends name="loadCoreGroups"/>
  </step>

  <step name="loadCoreGroupAASequence" stepClass="OrthoMCLWorkflow::Main::WorkflowSteps::InsertOrthoGroupAASequence">
      <paramValue name="groupsFile">$$peripheralDir$$/master/mainresult/GroupsFile.txt</paramValue>
      <paramValue name="isResidual">0</paramValue>
      <depends name="loadResidualGroups"/>
  </step>

  <step name="loadResidualGroupAASequence" stepClass="OrthoMCLWorkflow::Main::WorkflowSteps::InsertOrthoGroupAASequence">
      <paramValue name="groupsFile">$$peripheralDir$$/master/mainresult/Results/Orthogroups/Orthogroups.txt</paramValue>
      <paramValue name="isResidual">1</paramValue>
      <depends name="loadCoreGroupAASequence"/>
  </step>

  <step name="insertOrthogroupCoreStats" stepClass="OrthoMCLWorkflow::Main::WorkflowSteps::InsertOrthoGroupStats" stepLoadTypes="plugin">
      <paramValue name="groupStatsFile">$$coreResultsDir$$/groupStats/core_stats.txt</paramValue>
      <paramValue name="proteinSubset">C</paramValue>
      <depends name="loadResidualGroupAASequence"/>
  </step>

  <step name="insertOrthogroupCorePeripheralStats" stepClass="OrthoMCLWorkflow::Main::WorkflowSteps::InsertOrthoGroupStats" stepLoadTypes="plugin">
      <paramValue name="groupStatsFile">$$peripheralDir$$/master/mainresult/groupStats/peripheral_stats.txt</paramValue>
      <paramValue name="proteinSubset">C+P</paramValue>
      <depends name="insertOrthogroupCoreStats"/>
  </step>

  <step name="insertOrthogroupResidualStats" stepClass="OrthoMCLWorkflow::Main::WorkflowSteps::InsertOrthoGroupStats" stepLoadTypes="plugin">
      <paramValue name="groupStatsFile">$$peripheralDir$$/master/mainresult/groupStats/residual_stats.txt</paramValue>
      <paramValue name="proteinSubset">R</paramValue>
      <depends name="insertOrthogroupCorePeripheralStats"/>
  </step>

</workflowGraph>
