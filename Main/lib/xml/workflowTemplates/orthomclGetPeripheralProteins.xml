<workflowGraph name="">
  <param name="getPeripheralProteinsDir"/>
  <param name="residualFastaFilesDir"/>
  <param name="oldReleasesSequenceFilesDir"/>
  <param name="oldReleasesGroupFilesDir"/>
  <param name="parentDataDir"/>

  <constant name="proteomeDatasetsDir">$$getPeripheralProteinsDir$$/proteomeDatasets</constant>
  <constant name="proteomesDir">$$getPeripheralProteinsDir$$/peripheralProteomes</constant>
  <constant name="ecMappingsDir">$$getPeripheralProteinsDir$$/ecMappings</constant>
  <constant name="peripheralInterproDir">$$parentDataDir$$/peripheralInterpro</constant>

  <step name="makeGetPeripheralProteinsDir" stepClass="ReFlow::StepClasses::MakeDataDir">
    <paramValue name="dataDir">$$getPeripheralProteinsDir$$</paramValue>
  </step>

  <step name="mirrorGetPeripheralProteinsDirToCluster" stepClass="ReFlow::StepClasses::MirrorToComputeCluster">
    <paramValue name="fileOrDirToMirror">$$getPeripheralProteinsDir$$</paramValue>
    <depends name="makeGetPeripheralProteinsDir"/>
  </step>

  <step name="makeProteomeDatasetsDir" stepClass="ReFlow::StepClasses::MakeDataDir">
    <paramValue name="dataDir">$$proteomeDatasetsDir$$</paramValue>
    <depends name="mirrorGetPeripheralProteinsDirToCluster"/>
  </step>

  <step name="mirrorProteomeDatasetsDirToCluster" stepClass="ReFlow::StepClasses::MirrorToComputeCluster">
    <paramValue name="fileOrDirToMirror">$$proteomeDatasetsDir$$</paramValue>
    <depends name="makeProteomeDatasetsDir"/>
  </step>

  <step name="makeProteomesDir" stepClass="ReFlow::StepClasses::MakeDataDir">
    <paramValue name="dataDir">$$proteomesDir$$</paramValue>
    <depends name="mirrorProteomeDatasetsDirToCluster"/>
  </step>

  <step name="mirrorProteomesDirToCluster" stepClass="ReFlow::StepClasses::MirrorToComputeCluster">
    <paramValue name="fileOrDirToMirror">$$proteomesDir$$</paramValue>
    <depends name="makeProteomesDir"/>
  </step>

  <step name="makeResidualFastaFilesDir" stepClass="ReFlow::StepClasses::MakeDataDir">
    <paramValue name="dataDir">$$residualFastaFilesDir$$</paramValue>
    <depends name="mirrorProteomesDirToCluster"/>
  </step>

  <step name="mirrorResidualFastaFilesDirToCluster" stepClass="ReFlow::StepClasses::MirrorToComputeCluster">
    <paramValue name="fileOrDirToMirror">$$residualFastaFilesDir$$</paramValue>
    <depends name="makeResidualFastaFilesDir"/>
  </step>

  <step name="makeEcMappingsDir" stepClass="ReFlow::StepClasses::MakeDataDir">
    <paramValue name="dataDir">$$ecMappingsDir$$</paramValue>
    <depends name="mirrorResidualFastaFilesDirToCluster"/>
  </step>

  <datasetTemplate class="orthomclPeripheralFromVEuPathEBI">
    <prop name="projectName"/>
    <prop name="ebiOrganismName"/>
    <prop name="ebiVersion"/>
    <prop name="orthomclAbbrev"/>
    <prop name="oldAbbrevsList"/>
    <prop name="orthomclClade"/>
    <prop name="ncbiTaxonId"/>
    <prop name="organismName"/>
    <prop name="ebi2gusTag"/>
<!--
    <step name="${orthomclAbbrev}_insertPeripheralTaxon" stepClass="OrthoMCLWorkflow::Main::WorkflowSteps::InsertPeripheralTaxonNameVersion">
      <paramValue name="abbrev">${orthomclAbbrev}</paramValue>
      <paramValue name="orthomclClade">${orthomclClade}</paramValue> 
      <paramValue name="ncbiTaxonId">${ncbiTaxonId}</paramValue>
      <paramValue name="version">${ebiVersion}</paramValue>
      <paramValue name="organismName">${organismName}</paramValue>
      <depends name="mirrorResidualFastaFilesDirToCluster"/>
    </step>

    <step name="${orthomclAbbrev}_validatePeripheralTaxon" stepClass="OrthoMCLWorkflow::Main::WorkflowSteps::ValidateNcbiTaxonId">
      <paramValue name="abbrev">${orthomclAbbrev}</paramValue>
      <paramValue name="ncbiTaxonId">${ncbiTaxonId}</paramValue>
      <depends name="${orthomclAbbrev}_insertPeripheralTaxon"/>
    </step>

    <subgraph name="${orthomclAbbrev}_loadPeripheralDataset" xmlFile="loadDataset.xml">
      <paramValue name="datasetName">${orthomclAbbrev}_PeripheralFromEbi_RSRC</paramValue>
      <paramValue name="datasetLoaderXmlFileName">OrthoMCL.xml</paramValue>
      <paramValue name="parentDataDir">$$proteomeDatasetsDir$$</paramValue>
      <depends name="${orthomclAbbrev}_validatePeripheralTaxon"/>
    </subgraph>
-->
    <step name="${orthomclAbbrev}_makeDataDir" stepClass="ReFlow::StepClasses::MakeDataDir">
      <paramValue name="dataDir">$$proteomeDatasetsDir$$/${orthomclAbbrev}_PeripheralFromEbi_RSRC</paramValue>
      <depends name="makeEcMappingsDir"/>
    </step>

    <step name="${orthomclAbbrev}_runOrthoEbiDumper" stepClass="OrthoMCLWorkflow::Main::WorkflowSteps::RunOrthoEbiDumper" >
      <paramValue name="projectName">${projectName}</paramValue>
      <paramValue name="ncbiTaxonId">${ncbiTaxonId}</paramValue>
      <paramValue name="ebiOrganismName">${ebiOrganismName}</paramValue>
      <paramValue name="orthomclAbbrev">${orthomclAbbrev}</paramValue>
      <paramValue name="ebiVersion">${ebiVersion}</paramValue>
      <paramValue name="outputDir">$$proteomeDatasetsDir$$/${orthomclAbbrev}_PeripheralFromEbi_RSRC</paramValue>
      <paramValue name="ecFileName">ecFromEbi.tab</paramValue>
      <paramValue name="proteomeFileName">proteomeFromEbi.fasta</paramValue>
      <paramValue name="ebi2gusTag">${ebi2gusTag}</paramValue>
      <depends name="${orthomclAbbrev}_makeDataDir"/>
    </step>

    <step name="${orthomclAbbrev}_makeInterproDataDir" stepClass="ReFlow::StepClasses::MakeDataDir">
        <paramValue name="dataDir">$$peripheralInterproDir$$/${orthomclAbbrev}_orthomclProteome_RSRC</paramValue>
        <depends name="${orthomclAbbrev}_runOrthoEbiDumper"/>
    </step>

    <step name="${orthomclAbbrev}_findExemplarProteins" stepClass="OrthoMCLWorkflow::Main::WorkflowSteps::FindExemplarProteins" >
      <paramValue name="fastaFile">$$proteomeDatasetsDir$$/${orthomclAbbrev}_PeripheralFromEbi_RSRC/proteomeFromEbi.fasta</paramValue>
      <paramValue name="outputFile">$$proteomeDatasetsDir$$/${orthomclAbbrev}_PeripheralFromEbi_RSRC/exemplars.fasta</paramValue>
      <paramValue name="geneIdRegex">gene=(\S+)</paramValue>
      <paramValue name="proteinIdRegex">^>(\S+)</paramValue>
      <paramValue name="maxStopCodonPercent">20</paramValue>
      <paramValue name="preferredSource">sp</paramValue>
      <depends name="${orthomclAbbrev}_makeInterproDataDir"/>
    </step>

    <step name="${orthomclAbbrev}_makeAliasFile" stepClass="OrthoMCLWorkflow::Main::WorkflowSteps::MakeAliasFile" >
      <paramValue name="abbrev">${orthomclAbbrev}</paramValue>
      <paramValue name="firstFile">$$proteomeDatasetsDir$$/${orthomclAbbrev}_PeripheralFromEbi_RSRC/proteomeFromEbi.fasta</paramValue>
      <paramValue name="secondFile">$$proteomeDatasetsDir$$/${orthomclAbbrev}_PeripheralFromEbi_RSRC/exemplars.fasta</paramValue>
      <paramValue name="outputFile">$$proteomeDatasetsDir$$/${orthomclAbbrev}_PeripheralFromEbi_RSRC/aliases.tab</paramValue>
      <depends name="${orthomclAbbrev}_findExemplarProteins"/>
    </step>

    <step name="${orthomclAbbrev}_orgAbbrevSourceId" stepClass="OrthoMCLWorkflow::Main::WorkflowSteps::OrgAbbrevSourceId" >
      <paramValue name="abbrev">${orthomclAbbrev}</paramValue>
      <paramValue name="geneRegex">gene=(\S+)</paramValue>
      <paramValue name="inputFile">$$proteomeDatasetsDir$$/${orthomclAbbrev}_PeripheralFromEbi_RSRC/exemplars.fasta</paramValue>
      <paramValue name="outputFile">$$proteomeDatasetsDir$$/${orthomclAbbrev}_PeripheralFromEbi_RSRC/${orthomclAbbrev}.fasta</paramValue>
      <depends name="${orthomclAbbrev}_makeAliasFile"/>
    </step>

    <step name="${orthomclAbbrev}_makeGoodProteinsFile" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::OrthomclMakeGoodProteinsForSample">
      <paramValue name="proteomeFile">$$proteomeDatasetsDir$$/${orthomclAbbrev}_PeripheralFromEbi_RSRC/${orthomclAbbrev}.fasta</paramValue>
      <paramValue name="outputGoodProteinsFile">$$proteomesDir$$/${orthomclAbbrev}.fasta</paramValue>
      <paramValue name="outputBadProteinsFile">$$proteomeDatasetsDir$$/${orthomclAbbrev}_PeripheralFromEbi_RSRC/${orthomclAbbrev}_bad.fa</paramValue>
      <paramValue name="minLength">10</paramValue>
      <paramValue name="maxStopPercent">20</paramValue>
      <depends name="${orthomclAbbrev}_orgAbbrevSourceId"/>
    </step>

<!--
    <step name="${orthomclAbbrev}_insertPeripheralSequences" stepClass="OrthoMCLWorkflow::Main::WorkflowSteps::OrthoLoadFastaSequences">
      <paramValue name="externalDatabaseName">${orthomclAbbrev}_PeripheralFromEbi_RSRC</paramValue>
      <paramValue name="externalDatabaseVersion">${ebiVersion}</paramValue>
      <paramValue name="ncbiTaxonId">${ncbiTaxonId}</paramValue>
      <paramValue name="sequenceFile">$$proteomeDatasetsDir$$/${orthomclAbbrev}_PeripheralFromEbi_RSRC/${orthomclAbbrev}Proteome.fasta</paramValue>
      <paramValue name="regexSourceId">^>[^|]+\|(\S+)</paramValue>
      <paramValue name="regexSecondaryId">^>(\S+)</paramValue>
      <paramValue name="regexDesc">product=(.*)</paramValue>
      <paramValue name="regexName">gene=(\S*)</paramValue>
      <paramValue name="tableName">DoTS::ExternalAASequence</paramValue>
      <depends name="${orthomclAbbrev}_orgAbbrevSourceId"/>
    </step>
-->
    <step name="${orthomclAbbrev}_mirrorInterproToCluster" stepClass="ReFlow::StepClasses::MirrorToComputeCluster" stepLoadTypes="toCluster">
        <paramValue name="fileOrDirToMirror">$$peripheralInterproDir$$/${orthomclAbbrev}_orthomclProteome_RSRC</paramValue>
        <depends name="${orthomclAbbrev}_makeGoodProteinsFile"/>
    </step>

    <step name="${orthomclAbbrev}_mirrorProteomeDatasetToCluster" stepClass="ReFlow::StepClasses::MirrorToComputeCluster" stepLoadTypes="toCluster">
        <paramValue name="fileOrDirToMirror">$$proteomeDatasetsDir$$/${orthomclAbbrev}_PeripheralFromEbi_RSRC</paramValue>
        <depends name="${orthomclAbbrev}_mirrorInterproToCluster"/>
    </step>

    <subgraph name="${orthomclAbbrev}_InterproScan" xmlFile="interpro.xml">
        <paramValue name="proteinsFile">$$proteomeDatasetsDir$$/${orthomclAbbrev}_PeripheralFromEbi_RSRC/${orthomclAbbrev}.fasta</paramValue>
        <paramValue name="parentDataDir">$$peripheralInterproDir$$/${orthomclAbbrev}_orthomclProteome_RSRC</paramValue>
        <paramValue name="insertVersion">2</paramValue>
        <paramValue name="aaSeqTable">ExternalAASequence</paramValue>
        <paramValue name="sourceIdRegex">^\w+\|(\S+)</paramValue>
        <paramValue name="ncbiTaxId">${ncbiTaxonId}</paramValue>
        <depends name="${orthomclAbbrev}_mirrorProteomeDatasetToCluster"/>
    </subgraph>

<!--
    <step name="${orthomclAbbrev}_insertAliases" stepClass="OrthoMCLWorkflow::Main::WorkflowSteps::InsertAliases">
      <paramValue name="externalDatabase">${orthomclAbbrev}_PeripheralFromEbi_RSRC</paramValue>
      <paramValue name="inputMappingFile">$$proteomeDatasetsDir$$/${orthomclAbbrev}_PeripheralFromEbi_RSRC/aliases.tab</paramValue>
      <depends name="${orthomclAbbrev}_processProteome"/>
    </step>

    <step name="${orthomclAbbrev}_insertEcNumbers" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::InsertOrthoMCLDerivedEC">
      <paramValue name="inputFile">$$proteomeDatasetsDir$$/${orthomclAbbrev}_PeripheralFromEbi_RSRC/ecFromEbi.tab</paramValue>
      <paramValue name="evidenceCode">EBI</paramValue>
      <paramValue name="idSql">SELECT aa_sequence_id FROM dots.externalaasequence WHERE secondary_identifier = ?</paramValue>
      <depends name="${orthomclAbbrev}_runOrthoEbiDumper"/>
    </step>
-->
  </datasetTemplate>

  <datasetTemplate class="orthomclUniprotReferenceProteomeForPeripheral">
    <prop name="abbrev"/>
    <prop name="oldAbbrevsList"/>
    <prop name="orthomclClade"/>
    <prop name="ncbiTaxonId"/>
<!--
    <step name="${abbrev}_makeDataDir" stepClass="ReFlow::StepClasses::MakeDataDir">
      <paramValue name="dataDir">$$proteomeDatasetsDir$$/${abbrev}_orthomclPeripheralProteome_RSRC</paramValue>
      <depends name="makeEcMappingsDir"/>
    </step>
-->
    <subgraph name="${abbrev}_proteome" xmlFile="loadOrthomclPeripheralProteome.xml">
      <paramValue name="abbrev">${abbrev}</paramValue>
      <paramValue name="orthomclClade">${orthomclClade}</paramValue>
      <paramValue name="ncbiTaxonId">${ncbiTaxonId}</paramValue>
      <paramValue name="oldAbbrevsList">${oldAbbrevsList}</paramValue>
      <paramValue name="oldReleasesSequenceFilesDir">$$oldReleasesSequenceFilesDir$$</paramValue>
      <paramValue name="oldReleasesGroupFilesDir">$$oldReleasesGroupFilesDir$$</paramValue>
      <paramValue name="proteomeDatasetsDir">$$proteomeDatasetsDir$$</paramValue>
      <paramValue name="residualFastaFilesDir">$$residualFastaFilesDir$$</paramValue>
      <depends name="makeEcMappingsDir"/>
    </subgraph>

    <step name="${abbrev}_makeInterproDataDir" stepClass="ReFlow::StepClasses::MakeDataDir">
      <paramValue name="dataDir">$$peripheralInterproDir$$/${abbrev}_orthomclProteome_RSRC</paramValue>
      <depends name="${abbrev}_proteome"/>
    </step>

    <step name="${abbrev}_makeGoodProteinsFile" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::OrthomclMakeGoodProteinsForSample">
      <paramValue name="proteomeFile">$$proteomeDatasetsDir$$/${abbrev}_orthomclPeripheralProteome_RSRC/${abbrev}.fasta</paramValue>
      <paramValue name="outputGoodProteinsFile">$$proteomesDir$$/${abbrev}.fasta</paramValue>
      <paramValue name="outputBadProteinsFile">$$proteomeDatasetsDir$$/${abbrev}_orthomclPeripheralProteome_RSRC/${abbrev}_bad.fa</paramValue>
      <paramValue name="minLength">10</paramValue>
      <paramValue name="maxStopPercent">20</paramValue>
      <dependsPattern name="${abbrev}_makeInterproDataDir"/>
    </step>

    <step name="${abbrev}_mirrorInterproDirToCluster" stepClass="ReFlow::StepClasses::MirrorToComputeCluster" stepLoadTypes="toCluster">
      <paramValue name="fileOrDirToMirror">$$peripheralInterproDir$$/${abbrev}_orthomclProteome_RSRC</paramValue>
      <depends name="${abbrev}_makeGoodProteinsFile"/>
    </step>

    <step name="${abbrev}_mirrorProteomeDatasetToCluster" stepClass="ReFlow::StepClasses::MirrorToComputeCluster" stepLoadTypes="toCluster">
      <paramValue name="fileOrDirToMirror">$$proteomeDatasetsDir$$/${abbrev}_orthomclPeripheralProteome_RSRC</paramValue>
      <depends name="${abbrev}_mirrorInterproDirToCluster"/>
    </step>

    <subgraph name="${abbrev}_InterproScan" xmlFile="interpro.xml">
        <paramValue name="proteinsFile">$$proteomeDatasetsDir$$/${abbrev}_orthomclPeripheralProteome_RSRC/${abbrev}.fasta</paramValue>
        <paramValue name="parentDataDir">$$peripheralInterproDir$$/${abbrev}_orthomclProteome_RSRC</paramValue>
        <paramValue name="insertVersion">2</paramValue>
        <paramValue name="aaSeqTable">ExternalAASequence</paramValue>
        <paramValue name="sourceIdRegex">^\w+\|(\S+)</paramValue>
        <paramValue name="ncbiTaxId">${ncbiTaxonId}</paramValue>
        <depends name="${abbrev}_mirrorProteomeDatasetToCluster"/>
   </subgraph>

    <!-- a bit of a hack.  reach into the proteome dataset's dir to find the aliases file provided by the Eupath proteome dataset class -->

    <step name="${abbrev}_insertAliases" stepClass="OrthoMCLWorkflow::Main::WorkflowSteps::InsertAliases">
      <paramValue name="externalDatabase">${abbrev}_orthomclPeripheralProteome_RSRC</paramValue>
      <paramValue name="inputMappingFile">$$proteomeDatasetsDir$$/${abbrev}_orthomclPeripheralProteome_RSRC/aliases.tab</paramValue>
      <depends name="${abbrev}_proteome"/>
    </step>

  </datasetTemplate>

  <datasetTemplate class="orthomclUniprotEcForPeripheral">
    <prop name="abbrev"/>
    <subgraph name="${abbrev}_enzymes" xmlFile="loadDataset.xml">
      <paramValue name="datasetName">${abbrev}_Uniprot_ECAssociations_RSRC</paramValue>
      <paramValue name="datasetLoaderXmlFileName">OrthoMCL.xml</paramValue>
      <paramValue name="parentDataDir">$$ecMappingsDir$$</paramValue>
      <depends name="makeEcMappingsDir"/>
      <depends name="${abbrev}_insertAliases"/>
    </subgraph>
  </datasetTemplate>


  <datasetTemplate class="orthomclPeripheralFromManualDelivery">
    <prop name="orthomclAbbrev"/>
    <prop name="oldAbbrevsList"/>
    <prop name="orthomclClade"/>
    <prop name="ncbiTaxonId"/>
    <prop name="organismName"/>
    <prop name="version"/>

    <step name="${orthomclAbbrev}_insertPeripheralTaxon" stepClass="OrthoMCLWorkflow::Main::WorkflowSteps::InsertPeripheralTaxonNameVersion">
      <paramValue name="abbrev">${orthomclAbbrev}</paramValue>
      <paramValue name="orthomclClade">${orthomclClade}</paramValue> 
      <paramValue name="ncbiTaxonId">${ncbiTaxonId}</paramValue>
      <paramValue name="version">${version}</paramValue>
      <paramValue name="organismName">${organismName}</paramValue>
      <depends name="mirrorResidualFastaFilesDirToCluster"/>
    </step>

    <step name="${orthomclAbbrev}_validatePeripheralTaxon" stepClass="OrthoMCLWorkflow::Main::WorkflowSteps::ValidateNcbiTaxonId">
      <paramValue name="abbrev">${orthomclAbbrev}</paramValue>
      <paramValue name="ncbiTaxonId">${ncbiTaxonId}</paramValue>
      <depends name="${orthomclAbbrev}_insertPeripheralTaxon"/>
    </step>

    <subgraph name="${orthomclAbbrev}_loadPeripheralDataset" xmlFile="loadDataset.xml">
      <paramValue name="datasetName">${orthomclAbbrev}_PeripheralFromManualDelivery_RSRC</paramValue>
      <paramValue name="datasetLoaderXmlFileName">OrthoMCL.xml</paramValue>
      <paramValue name="parentDataDir">$$proteomeDatasetsDir$$</paramValue>
      <depends name="${orthomclAbbrev}_validatePeripheralTaxon"/>
    </subgraph>

    <step name="${orthomclAbbrev}_getProteomeFromManualDelivery" stepClass="OrthoMCLWorkflow::Main::WorkflowSteps::GetProteomeFromManualDelivery" >
      <paramValue name="manualDeliveryFile">@@manualDeliveryDir@@/OrthoMCL/proteomes/${organismName}/${version}/final/proteins.fasta.gz</paramValue>
      <paramValue name="outputDir">$$proteomeDatasetsDir$$/${orthomclAbbrev}_PeripheralFromManualDelivery_RSRC</paramValue>
      <paramValue name="outputFile">proteins.fasta</paramValue>
      <depends name="${orthomclAbbrev}_loadPeripheralDataset"/>
    </step>

    <step name="${orthomclAbbrev}_findExemplarProteins" stepClass="OrthoMCLWorkflow::Main::WorkflowSteps::FindExemplarProteins" >
      <paramValue name="fastaFile">$$proteomeDatasetsDir$$/${orthomclAbbrev}_PeripheralFromManualDelivery_RSRC/proteins.fasta</paramValue>
      <paramValue name="outputFile">$$proteomeDatasetsDir$$/${orthomclAbbrev}_PeripheralFromManualDelivery_RSRC/exemplars.fasta</paramValue>
      <paramValue name="geneIdRegex">gene=(\S+)</paramValue>
      <paramValue name="proteinIdRegex">^>(\S+)</paramValue>
      <paramValue name="maxStopCodonPercent">20</paramValue>
      <paramValue name="preferredSource">sp</paramValue>
      <depends name="${orthomclAbbrev}_getProteomeFromManualDelivery"/>
    </step>

    <step name="${orthomclAbbrev}_makeAliasFile" stepClass="OrthoMCLWorkflow::Main::WorkflowSteps::MakeAliasFile" >
      <paramValue name="abbrev">${orthomclAbbrev}</paramValue>
      <paramValue name="firstFile">$$proteomeDatasetsDir$$/${orthomclAbbrev}_PeripheralFromManualDelivery_RSRC/proteins.fasta</paramValue>
      <paramValue name="secondFile">$$proteomeDatasetsDir$$/${orthomclAbbrev}_PeripheralFromManualDelivery_RSRC/exemplars.fasta</paramValue>
      <paramValue name="outputFile">$$proteomeDatasetsDir$$/${orthomclAbbrev}_PeripheralFromManualDelivery_RSRC/aliases.tab</paramValue>
      <depends name="${orthomclAbbrev}_findExemplarProteins"/>
    </step>

    <step name="${orthomclAbbrev}_orgAbbrevSourceId" stepClass="OrthoMCLWorkflow::Main::WorkflowSteps::OrgAbbrevSourceId" >
      <paramValue name="abbrev">${orthomclAbbrev}</paramValue>
      <paramValue name="geneRegex">gene=(\S+)</paramValue>
      <paramValue name="inputFile">$$proteomeDatasetsDir$$/${orthomclAbbrev}_PeripheralFromManualDelivery_RSRC/exemplars.fasta</paramValue>
      <paramValue name="outputFile">$$proteomeDatasetsDir$$/${orthomclAbbrev}_PeripheralFromManualDelivery_RSRC/${orthomclAbbrev}Proteome.fasta</paramValue>
      <depends name="${orthomclAbbrev}_makeAliasFile"/>
    </step>

    <step name="${orthomclAbbrev}_insertPeripheralSequences" stepClass="OrthoMCLWorkflow::Main::WorkflowSteps::OrthoLoadFastaSequences">
      <paramValue name="externalDatabaseName">${orthomclAbbrev}_PeripheralFromManualDelivery_RSRC</paramValue>
      <paramValue name="externalDatabaseVersion">${version}</paramValue>
      <paramValue name="ncbiTaxonId">${ncbiTaxonId}</paramValue>
      <paramValue name="sequenceFile">$$proteomeDatasetsDir$$/${orthomclAbbrev}_PeripheralFromManualDelivery_RSRC/${orthomclAbbrev}Proteome.fasta</paramValue>
      <paramValue name="regexSourceId">^>[^|]+\|(\S+)</paramValue>
      <paramValue name="regexSecondaryId">^>(\S+)</paramValue>
      <paramValue name="regexDesc">product=(.*)</paramValue>
      <paramValue name="regexName">gene=(\S*)</paramValue>
      <paramValue name="tableName">DoTS::ExternalAASequence</paramValue>
      <depends name="${orthomclAbbrev}_orgAbbrevSourceId"/>
    </step>

    <subgraph name="${orthomclAbbrev}_processProteome" xmlFile="processPeripheralProteome.xml">
      <paramValue name="abbrev">${orthomclAbbrev}</paramValue>
      <paramValue name="orthomclClade">${orthomclClade}</paramValue>
      <paramValue name="oldAbbrevsList">${oldAbbrevsList}</paramValue>
      <paramValue name="oldReleasesSequenceFilesDir">$$oldReleasesSequenceFilesDir$$</paramValue>
      <paramValue name="oldReleasesGroupFilesDir">$$oldReleasesGroupFilesDir$$</paramValue>
      <paramValue name="proteomeDatasetsDir">$$proteomeDatasetsDir$$</paramValue>
      <paramValue name="residualFastaFilesDir">$$residualFastaFilesDir$$</paramValue>
      <paramValue name="datasetName">${orthomclAbbrev}_PeripheralFromManualDelivery_RSRC</paramValue>
      <depends name="${orthomclAbbrev}_insertPeripheralSequences"/>
    </subgraph>

    <step name="${orthomclAbbrev}_insertAliases" stepClass="OrthoMCLWorkflow::Main::WorkflowSteps::InsertAliases">
      <paramValue name="externalDatabase">${orthomclAbbrev}_PeripheralFromManualDelivery_RSRC</paramValue>
      <paramValue name="inputMappingFile">$$proteomeDatasetsDir$$/${orthomclAbbrev}_PeripheralFromManualDelivery_RSRC/aliases.tab</paramValue>
      <depends name="${orthomclAbbrev}_processProteome"/>
    </step>

  </datasetTemplate>

  <datasetTemplate class="orthomclUniprotProteomeForPeripheral">
    <prop name="abbrev"/>
    <prop name="oldAbbrevsList"/>
    <prop name="orthomclClade"/>
    <prop name="ncbiTaxonId"/>
    <subgraph name="${abbrev}_proteome" xmlFile="loadOrthomclPeripheralProteome.xml">
      <paramValue name="abbrev">${abbrev}</paramValue>
      <paramValue name="orthomclClade">${orthomclClade}</paramValue>
      <paramValue name="ncbiTaxonId">${ncbiTaxonId}</paramValue>
      <paramValue name="oldAbbrevsList">${oldAbbrevsList}</paramValue>
      <paramValue name="oldReleasesSequenceFilesDir">$$oldReleasesSequenceFilesDir$$</paramValue>
      <paramValue name="oldReleasesGroupFilesDir">$$oldReleasesGroupFilesDir$$</paramValue>
      <paramValue name="proteomeDatasetsDir">$$proteomeDatasetsDir$$</paramValue>
      <paramValue name="residualFastaFilesDir">$$residualFastaFilesDir$$</paramValue>
      <depends name="mirrorResidualFastaFilesDirToCluster"/>
    </subgraph>

    <!-- a bit of a hack.  reach into the proteome dataset's dir to find the aliases file provided by the Eupath proteome dataset class -->
    <step name="${abbrev}_insertAliases" stepClass="OrthoMCLWorkflow::Main::WorkflowSteps::InsertAliases">
      <paramValue name="externalDatabase">${abbrev}_orthomclPeripheralProteome_RSRC</paramValue>
      <paramValue name="inputMappingFile">$$proteomeDatasetsDir$$/${abbrev}_orthomclPeripheralProteome_RSRC/aliases.tab</paramValue>
      <depends name="${abbrev}_proteome"/>
    </step>
  </datasetTemplate>

  <datasetTemplate class="orthomclEuPathProteomeForPeripheral">
    <prop name="abbrev"/>
    <prop name="oldAbbrevsList"/>
    <prop name="orthomclClade"/>
    <prop name="ncbiTaxonId"/>

    <subgraph name="${abbrev}_proteome" xmlFile="loadOrthomclPeripheralProteome.xml">
      <paramValue name="abbrev">${abbrev}</paramValue>
      <paramValue name="orthomclClade">${orthomclClade}</paramValue>
      <paramValue name="ncbiTaxonId">${ncbiTaxonId}</paramValue>
      <paramValue name="oldAbbrevsList">${oldAbbrevsList}</paramValue>
      <paramValue name="oldReleasesSequenceFilesDir">$$oldReleasesSequenceFilesDir$$</paramValue>
      <paramValue name="oldReleasesGroupFilesDir">$$oldReleasesGroupFilesDir$$</paramValue>
      <paramValue name="proteomeDatasetsDir">$$proteomeDatasetsDir$$</paramValue>
      <paramValue name="residualFastaFilesDir">$$residualFastaFilesDir$$</paramValue>
      <depends name="makeEcMappingsDir"/>
    </subgraph>

    <step name="${abbrev}_makeInterproDataDir" stepClass="ReFlow::StepClasses::MakeDataDir">
      <paramValue name="dataDir">$$peripheralInterproDir$$/${abbrev}_orthomclPeripheralProteome_RSRC</paramValue>
      <depends name="${abbrev}_proteome"/>
    </step>

    <step name="${abbrev}_makeGoodProteinsFile" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::OrthomclMakeGoodProteinsForSample">
      <paramValue name="proteomeFile">$$proteomeDatasetsDir$$/${abbrev}_orthomclPeripheralProteome_RSRC/${abbrev}.fasta</paramValue>
      <paramValue name="outputGoodProteinsFile">$$proteomesDir$$/${abbrev}.fasta</paramValue>
      <paramValue name="outputBadProteinsFile">$$proteomeDatasetsDir$$/${abbrev}_orthomclPeripheralProteome_RSRC/${abbrev}_bad.fa</paramValue>
      <paramValue name="minLength">10</paramValue>
      <paramValue name="maxStopPercent">20</paramValue>
      <dependsPattern name="${abbrev}_makeInterproDataDir"/>
    </step>

    <step name="${abbrev}_mirrorInterproDirToCluster" stepClass="ReFlow::StepClasses::MirrorToComputeCluster" stepLoadTypes="toCluster">
      <paramValue name="fileOrDirToMirror">$$peripheralInterproDir$$/${abbrev}_orthomclPeripheralProteome_RSRC</paramValue>
      <depends name="${abbrev}_makeGoodProteinsFile"/>
    </step>

    <step name="${abbrev}_mirrorProteomeDatasetToCluster" stepClass="ReFlow::StepClasses::MirrorToComputeCluster" stepLoadTypes="toCluster">
      <paramValue name="fileOrDirToMirror">$$proteomeDatasetsDir$$/${abbrev}_orthomclPeripheralProteome_RSRC</paramValue>
      <depends name="${abbrev}_mirrorInterproDirToCluster"/>
    </step>

    <subgraph name="${abbrev}_InterproScan" xmlFile="interpro.xml">
        <paramValue name="proteinsFile">$$proteomeDatasetsDir$$/${abbrev}_orthomclPeripheralProteome_RSRC/${abbrev}.fasta</paramValue>
        <paramValue name="parentDataDir">$$peripheralInterproDir$$/${abbrev}_orthomclPeripheralProteome_RSRC</paramValue>
        <paramValue name="insertVersion">2</paramValue>
        <paramValue name="aaSeqTable">ExternalAASequence</paramValue>
        <paramValue name="sourceIdRegex">^\w+\|(\S+)</paramValue>
        <paramValue name="ncbiTaxId">${ncbiTaxonId}</paramValue>
        <depends name="${abbrev}_mirrorProteomeDatasetToCluster"/>
   </subgraph>

    <!-- a bit of a hack.  reach into the proteome dataset's dir to find the aliases file provided by the Eupath proteome dataset class -->

    <step name="${abbrev}_insertAliases" stepClass="OrthoMCLWorkflow::Main::WorkflowSteps::InsertAliases">
      <paramValue name="externalDatabase">${abbrev}_orthomclPeripheralProteome_RSRC</paramValue>
      <paramValue name="inputMappingFile">$$proteomeDatasetsDir$$/${abbrev}_orthomclPeripheralProteome_RSRC/aliases.tab</paramValue>
      <depends name="${abbrev}_proteome"/>
    </step>

  </datasetTemplate>

  <datasetTemplate class="orthomclEuPathEcForPeripheral">
    <prop name="abbrev"/>
    <subgraph name="${abbrev}_enzymes" xmlFile="loadDataset.xml">
      <paramValue name="datasetName">${abbrev}_Eupath_ECAssociations_RSRC</paramValue>
      <paramValue name="datasetLoaderXmlFileName">OrthoMCL.xml</paramValue>
      <paramValue name="parentDataDir">$$ecMappingsDir$$</paramValue>
      <depends name="makeEcMappingsDir"/>
      <depends name="${abbrev}_insertAliases"/>
    </subgraph>
  </datasetTemplate>

  <step name="makeProteomeFastasDir" stepClass="ReFlow::StepClasses::MakeDataDir">
    <paramValue name="dataDir">$$getPeripheralProteinsDir$$/fastas</paramValue>
    <dependsPattern name="*_mirrorProteomeDatasetToCluster"/>
  </step>

  <step name="MakeOrthofinderInputDir" stepClass="OrthoMCLWorkflow::Main::WorkflowSteps::MakeOrthofinderInputDir">
    <paramValue name="proteomesDir">$$proteomesDir$$</paramValue>
    <paramValue name="outputDir">$$getPeripheralProteinsDir$$</paramValue>
    <depends name="makeProteomeFastasDir"/>
  </step>

  <step name="mirrorProteinsToCluster" stepClass="ReFlow::StepClasses::MirrorToComputeCluster">
    <paramValue name="fileOrDirToMirror">$$getPeripheralProteinsDir$$/fastas.tar.gz</paramValue>
    <depends name="MakeOrthofinderInputDir"/>
  </step>

</workflowGraph>
